# 优化打包构建速度



## HMR (Hot Module Replacement)

我们修改了某个模块/文件的代码，webpack会重新打包整个项目，这就导致webpack对整个项目重新打包编译，我们可以在webpack中配置HMR从而做到只重新编译被修改模块/文件的代码，从而提升编译速度。

### HMR 加载样式

为此我们需在webpack的 `devServer` 中配置 `hot: true` 即可开启HMR（webpack5默认开启）：

```javascript
module.exports = {
  ...
  devServer: {
    host: "localhost",
    port: "3000",
    hot: true, // 开启HMR功能（只能用于开发环境，生产环境不需要了）
  },
};
```

然后借助于 `style-loader` 当每次对css文件修改时，被修改部分的样式会被重新编译。

### HMR 加载JS文件

对于js文件实现HMR功能，需借助其他插件，比如在 react 项目中需安装 [react-hot-loader](https://github.com/gaearon/react-hot-loader) 来实现HMR。

<font color="red">注意：HMR在生产环境并不适用。</font>



## OneOf

webpack在把某个文件交给loader处理时，会遍历 `module.rules` 中所有的loader，即使这些loader中第一个就命中，webpack还是会遍历剩下的loader，我们可以使用 `oneOf` 根据文件类型加载对应的loader，只要命中就退出 loader 的匹配。

在 `webpack.config.js` 中配置：

```javascript
module.exports = {
  ...
  module: {
    rules: [
      {
        oneOf: [
          {
            test: /\.css$/,
            use: [
              MiniCssExtractPlugin.loader,
              "css-loader",
              {
                loader: "postcss-loader",
                options: {
                  postcssOptions: {
                    plugins: [
                      "postcss-preset-env",
                    ],
                  },
                },
              },
            ],
          },
          {
            test: /\.s(a|c)ss$/,
            use: [
              MiniCssExtractPlugin.loader,
              "css-loader",
              {
                loader: "postcss-loader",
                options: {
                  postcssOptions: {
                    plugins: [
                      "postcss-preset-env",
                    ],
                  },
                },
              },
              "sass-loader",
            ],
          },
        ],
      },
    ],
  },
};
```

有几点需要注意：

* 对于同一类型文件，比如处理js，如果需要多个loader，可以单独抽离js处理，确保oneOf里面一个文件类型对应一个loader
* 可以配置 `enforce: 'pre'` 指定优先执行



## Include/Exclude

Include/Exclude 用来告知loaders/plugins在处理文件时包含/排除哪些目录，比如要排除node_modules目录就可以通过 `exclude: /node_modules/` 来指定。

* include：只处理某些文件夹/文件
* exclude：排除某些文件夹/文件，优先级更高

通常来说Include/Exclude二者只能存其一，如果同时保留有Include/Exclude，会优先匹配Exclude。



## Cache

每次打包时 JS 文件都要经过 ESLint 检查 和 Babel 编译，我们可以缓存之前的 ESLint 检查 和 Babel 编译结果只对修改部分做检查和处理，从而提升打包速度。

在 `webpack.config.js` 中配置：

```javascript
const path = require("path");
const ESLintWebpackPlugin = require("eslint-webpack-plugin");

module.exports = {
  ...
  module: {
    rules: [
      {
        oneOf: [
          {
            test: /\.js$/,
            exclude: /node_modules/, // 排除node_modules代码不编译
            loader: "babel-loader",
            options: {
              cacheDirectory: true, // 开启babel编译缓存
              cacheCompression: false, // 缓存文件不要压缩
            },
          },
        ],
      },
    ],
  },
  plugins: [
    new ESLintWebpackPlugin({
      context: path.resolve(__dirname , "src"),
      cache: true,
      cacheLocation: path.resolve(__dirname, "./cache/.eslintcache"),
    }),
  ],
};
```